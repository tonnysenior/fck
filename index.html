<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCK Dynamisk Quiz Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        body { font-family: 'Inter', sans-serif; }
        .correct { background-color: #28a745 !important; color: white !important; }
        .incorrect { background-color: #dc3545 !important; color: white !important; }
        .rationale { font-size: 0.8rem; color: #6c757d; margin-top: 4px; }
        button:disabled {
            opacity: 0.6;
            cursor: default;
            transform: none !important;
            box-shadow: none !important;
        }
        #name-input:focus, #text-answer-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        em { font-style: italic; }
        .quiz-button {
            transition: all 0.2s ease-in-out;
        }
        .quiz-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #timer-display {
            transition: color 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen p-4 pt-16 md:pt-4 md:items-center">
    <div id="start-screen" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-xl text-center">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-blue-900">FCK Quiz Generator</h1>
        <div id="name-entry">
             <label for="name-input" class="block text-lg font-semibold mb-2 text-gray-700">Dit navn:</label>
             <input type="text" id="name-input" value="FCK Fan" class="w-full px-4 py-2 border border-gray-300 rounded-md mb-4" autocomplete="off">
        </div>
        <label class="block text-lg font-semibold mb-3 text-gray-700">Vælg sværhedsgrad:</label>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <button id="start-easy-quiz" class="quiz-button w-full px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">
                <span class="block text-xl">Let</span>
                <span class="block text-xs">Start her for at låse op</span>
            </button>
            <button id="start-normal-quiz" class="quiz-button w-full px-4 py-3 bg-blue-600 text-white rounded-md opacity-60 cursor-not-allowed" disabled>
                <span class="block text-xl">Normal [Locked]</span>
                <span class="block text-xs">Klar 'Let' for at låse op</span>
            </button>
            <button id="start-hard-quiz" class="quiz-button w-full px-4 py-3 bg-red-600 text-white rounded-md opacity-60 cursor-not-allowed" disabled>
                <span class="block text-xl">Ekspert [Locked]</span>
                <span class="block text-xs">Mest Frit Svar (15s. timer)</span>
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-3">
            Du skal klare et niveau med 100% rigtige for at låse op for det næste.<br>
            <strong>Tip:</strong> Slet "FCK Fan" og skriv dit eget navn, hvis du vil!
        </p>
    </div>

    <div id="quiz-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-xl text-center hidden">
        <div id="timer-display" class="hidden text-3xl font-bold mb-4">15</div>
        <h1 id="quiz-title" class="text-2xl md:text-3xl font-bold mb-6 text-blue-900">FCK Quiz</h1>
        <div id="question-area" class="mb-6">
            <p id="question-number" class="text-sm text-gray-500 mb-2"></p>
            <p id="question-text" class="text-lg font-semibold mb-4"></p>
            <div id="answer-options" class="grid grid-cols-1 gap-3"></div>
            <div id="text-input-area" class="hidden mt-4">
                <input type="text" id="text-answer-input" placeholder="Indtast dit svar..." class="w-full px-4 py-2 border border-gray-300 rounded-md mb-3" autocomplete="off">
                <button id="submit-text-answer" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Svar</button>
            </div>
            <div id="inline-feedback-area" class="mt-4 hidden border-t pt-4">
                <p id="feedback-question-text" class="text-sm italic text-gray-600 mb-2"></p>
                <p id="feedback-text" class="font-semibold mb-2"></p>
                <p id="rationale-text" class="text-sm text-gray-700"></p>
                <button id="inline-next-button" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition hidden">Næste Spørgsmål</button>
            </div>
        </div>
        <div id="results-area" class="hidden text-center">
            <h2 class="text-xl font-bold mb-4">Resultat for <span id="player-name" class="text-blue-700"></span></h2>
            <p id="score" class="text-lg mb-4"></p>
            <p id="final-message" class="mb-6"></p>
            <button id="continue-to-next-level-button" class="quiz-button w-full px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold mt-4 hidden">
                Fortsæt til Næste Niveau
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
                <button id="restart-same-quiz-button" class="quiz-button px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Tag Samme Quiz Igen</button>
                <button id="restart-new-quiz-button" class="quiz-button w-full md:w-auto px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">Ny Quiz (Resterende Pulje)</button>
            </div>
            <button id="email-button" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition mt-4 w-full">Send Resultat via E-mail</button>
            <button id="back-to-start-button" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition mt-2 w-full">Tilbage til Start</button>
        </div>
    </div>

    <script>
        // === DATABASER ===
        const spillerDatabase = [ /* ... DIN DATABASE HER – UÆNDRET ... */ ];
        const stabDatabase = [ /* ... DIN STAB HER ... */ ];
        const personDatabase = [...spillerDatabase, ...stabDatabase];

        // === GLOBALE VARIABLER ===
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let playerName = 'FCK Fan';
        let quizData = { questions: [] };
        let sessionUsedPersons = [];
        let currentDifficulty = 'normal';
        let quizInProgress = false;
        let timerInterval = null;
        let timeLeft = 15;
        const TIMER_DURATION = 15;

        // === DOM ELEMENTER ===
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const nameInput = document.getElementById('name-input');
        const startEasyButton = document.getElementById('start-easy-quiz');
        const startNormalButton = document.getElementById('start-normal-quiz');
        const startHardButton = document.getElementById('start-hard-quiz');
        const quizTitleEl = document.getElementById('quiz-title');
        const questionArea = document.getElementById('question-area');
        const resultsArea = document.getElementById('results-area');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const answerOptionsEl = document.getElementById('answer-options');
        const inlineFeedbackArea = document.getElementById('inline-feedback-area');
        const feedbackTextEl = document.getElementById('feedback-text');
        const rationaleTextEl = document.getElementById('rationale-text');
        const feedbackQuestionTextEl = document.getElementById('feedback-question-text');
        const inlineNextButton = document.getElementById('inline-next-button');
        const scoreEl = document.getElementById('score');
        const finalMessageEl = document.getElementById('final-message');
        const playerNameEl = document.getElementById('player-name');
        const emailButton = document.getElementById('email-button');
        const backToStartButton = document.getElementById('back-to-start-button');
        const restartSameQuizButton = document.getElementById('restart-same-quiz-button');
        const restartNewQuizButton = document.getElementById('restart-new-quiz-button');
        const textInputArea = document.getElementById('text-input-area');
        const textAnswerInput = document.getElementById('text-answer-input');
        const submitTextAnswer = document.getElementById('submit-text-answer');
        const continueToNextLevelButton = document.getElementById('continue-to-next-level-button');
        const timerDisplay = document.getElementById('timer-display');

        // === HJÆLPEFUNKTIONER ===
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getUniqueWrongOptions(sourceArray, correctValue, count) {
            const wrongOptions = new Set();
            const shuffledSource = shuffleArray([...sourceArray]);
            for (const item of shuffledSource) {
                if (item !== correctValue) wrongOptions.add(item);
                if (wrongOptions.size >= count) break;
            }
            return Array.from(wrongOptions);
        }

        // Fleksibel navnesammenligning
        function isCorrectName(given, correctFullName) {
            const normalize = s => s.trim().toLowerCase().replace(/[^a-zæøå]/g, '');
            const givenNorm = normalize(given);
            const [first,1, ...last] = correctFullName.split(' ');
            const firstNorm = normalize(first);
            const lastNorm = normalize(last.join(' '));
            const fullNorm = normalize(correctFullName);
            return givenNorm === fullNorm || givenNorm === firstNorm || givenNorm === lastNorm || givenNorm.includes(firstNorm) || givenNorm.includes(lastNorm);
        }

        // === QUIZ GENERATOR ===
        const questionTypes = { SPILLER_NR_TIL_NAVN: 0, SPILLER_NAVN_TIL_NR: 1, PERSON_NAVN_TIL_POS: 2, PERSON_NAVN_TIL_NAT: 3, PERSON_NAVN_TIL_AAR: 4, STAB_POS_TIL_NAVN: 5, TÆL_NATIONALITET: 6 };
        const difficultySettings = {
            easy: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT ],
            normal: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT, questionTypes.STAB_POS_TIL_NAVN ],
            hard: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT, questionTypes.PERSON_NAVN_TIL_AAR, questionTypes.STAB_POS_TIL_NAVN, questionTypes.TÆL_NATIONALITET ]
        };

        function generateRandomQuiz(difficulty) {
            const allowedTypes = difficultySettings[difficulty];
            quizTitleEl.textContent = `FCK Quiz (${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)})`;
            let availablePlayers = spillerDatabase.filter(p => !sessionUsedPersons.some(used => used.navn === p.navn));
            let availableStab = stabDatabase.filter(s => !sessionUsedPersons.some(used => used.navn === s.navn));
            let totalAvailable = (difficulty === 'easy') ? availablePlayers.length : availablePlayers.length + availableStab.length;

            if (totalAvailable < 4) {
                alert("Alle personer fra denne sværhedsgrads pulje er blevet brugt! Vi starter forfra.");
                sessionUsedPersons = [];
                availablePlayers = [...spillerDatabase];
                availableStab = [...stabDatabase];
                totalAvailable = (difficulty === 'easy') ? availablePlayers.length : availablePlayers.length + availableStab.length;
            }

            const numQuestions = Math.min(10, totalAvailable);
            const newQuestions = [];
            let quizPersons = [];

            while (newQuestions.length < numQuestions) {
                if ((difficulty === 'easy' && availablePlayers.length === 0) || 
                    (difficulty !== 'easy' && availablePlayers.length === 0 && availableStab.length === 0)) break;

                const questionType = allowedTypes[Math.floor(Math.random() * allowedTypes.length)];
                const isTextInput = (difficulty === 'hard' && 
                    [questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_AAR, questionTypes.TÆL_NATIONALITET].includes(questionType));

                let correctPerson = null;
                let questionData = null;

                switch(questionType) {
                    case questionTypes.SPILLER_NR_TIL_NAVN: {
                        correctPerson = shuffleArray(availablePlayers).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        questionData = { question: `Hvem bærer rygnummer ${correctPerson.nummer}?`, correct: correctPerson.navn, rationale: `${correctPerson.navn} bærer korrekt nummer ${correctPerson.nummer}.` };
                        if (!isTextInput) {
                            const wrongPlayers = personDatabase.filter(p => p.navn !== correctPerson.navn && p.type === 'Spiller');
                            questionData.wrong = getUniqueWrongOptions(wrongPlayers.map(p => p.navn), correctPerson.navn, 3).map(navn => ({ text: navn, rationale: `${navn} bærer nummer ${personDatabase.find(p => p.navn === navn).nummer}.` }));
                        }
                        break;
                    }
                    // ... (alle andre cases – uændrede) ...
                }

                if (questionData && correctPerson) {
                    if (isTextInput) {
                        newQuestions.push({ 
                            questionNumber: newQuestions.length + 1, 
                            question: questionData.question, 
                            isTextInput: true, 
                            correctAnswer: questionData.correct, 
                            rationale: questionData.rationale, 
                            questionType, 
                            fullName: correctPerson.navn 
                        });
                    } else {
                        const answerOptions = [{ text: questionData.correct, rationale: questionData.rationale, isCorrect: true }];
                        questionData.wrong.forEach(opt => answerOptions.push({ text: opt.text, rationale: opt.rationale, isCorrect: false }));
                        shuffleArray(answerOptions);
                        newQuestions.push({ 
                            questionNumber: newQuestions.length + 1, 
                            question: questionData.question, 
                            answerOptions, 
                            isTextInput: false 
                        });
                    }
                    quizPersons.push(correctPerson.navn);
                    sessionUsedPersons.push(correctPerson);
                    availablePlayers = availablePlayers.filter(p => p.navn !== correctPerson.navn);
                    availableStab = availableStab.filter(s => s.navn !== correctPerson.navn);
                }
            }

            quizData = { questions: newQuestions };
            startQuizLogic();
        }

        function startQuizLogic() {
            playerName = (nameInput.value || '').trim() || 'FCK Fan';  // FIX 1
            startScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            questionArea.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            questions = [...quizData.questions];
            if (questions.length === 0) {
                alert("Ingen spørgsmål – starter forfra!");
                goBackToStart();
                return;
            }
            loadQuestion();
        }

        function goBackToStart() {
            stopTimer();
            quizContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
            nameInput.value = playerName || 'FCK Fan';  // FIX 3
            sessionUsedPersons = [];
        }

        function startQuizFromMenu(difficulty) {
            playerName = (nameInput.value || '').trim() || 'FCK Fan';  // FIX 2
            currentDifficulty = difficulty;
            sessionUsedPersons = [];
            generateRandomQuiz(difficulty);
        }

        // ... (resten af koden – uændret) ...
    </script>
</body>
</html>
