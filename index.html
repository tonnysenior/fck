<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCK Dynamisk Quiz Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .correct { background-color: #28a745 !important; color: white !important; }
        .incorrect { background-color: #dc3545 !important; color: white !important; }
        .rationale { font-size: 0.8rem; color: #6c757d; margin-top: 4px; }
        button:disabled { 
            opacity: 0.6; 
            cursor: default;
            transform: none !important; 
            box-shadow: none !important; 
        }
        #name-input:focus, #text-answer-input:focus { 
            outline: none; 
            box-shadow: 0 0 0 2px #3b82f6; 
            border-color: #3b82f6;
        }
        em { font-style: italic; }
        .quiz-button {
            transition: all 0.2s ease-in-out;
        }
        .quiz-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #timer-display {
            transition: color 0.3s ease-in-out;
        }
        #progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 999px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 1rem;
        }
        #progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3b82f6; /* blue-500 */
            transition: width 0.4s ease-in-out;
        }
        #timer-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 999px;
            overflow: hidden;
            height: 6px;
            margin-bottom: 1rem;
        }
        #timer-bar {
            height: 100%;
            width: 100%;
            background-color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen p-4 pt-16 md:pt-4 md:items-center">
    
    <div id="start-screen" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-xl text-center">
        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-blue-900">FCK Quiz Generator</h1>
        <div id="name-entry">
             <label for="name-input" class="block text-lg font-semibold mb-2 text-gray-700">Dit navn:</label>
             <input type="text" id="name-input" placeholder="FCK Fan" class="w-full px-4 py-2 border border-gray-300 rounded-md mb-4" autocomplete="off">
        </div>
        <label class="block text-lg font-semibold mb-3 text-gray-700">Vælg sværhedsgrad:</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="start-easy-quiz" class="quiz-button w-full px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">
                <span class="block text-xl">Let</span>
                <span class="block text-xs">Start her for at låse op</span>
            </button>
            <button id="start-normal-quiz" class="quiz-button w-full px-4 py-3 bg-blue-600 text-white rounded-md opacity-60 cursor-not-allowed" disabled>
                <span class="block text-xl">Normal [Locked]</span>
                <span class="block text-xs">Klar 'Let' med 100%</span>
            </button>
            <button id="start-hard-quiz" class="quiz-button w-full px-4 py-3 bg-red-600 text-white rounded-md opacity-60 cursor-not-allowed" disabled>
                <span class="block text-xl">Ekspert [Locked]</span>
                <span class="block text-xs">Klar 'Normal' med 90%</span>
            </button>
            <button id="start-straffespark-quiz" class="quiz-button w-full px-4 py-3 bg-gray-800 text-white rounded-md hover:bg-gray-900 font-semibold hidden md:col-span-2">
                <span class="block text-xl">⚡ Straffespark ⚡</span>
                <span class="block text-xs">Låst op! Spil til du svarer forkert.</span>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 text-xs text-gray-500 border-t pt-4">
            <p id="easy-highscore-display">Rekord: 0 / 10 (-)</p>
            <p id="normal-highscore-display">Rekord: 0 / 10 (-)</p>
            <p id="hard-highscore-display">Rekord: 0 / 10 (-)</p>
        </div>
        <p id="straffespark-highscore-display" class="text-xs text-gray-500 mt-2">Straffespark Rekord: 0 (-)</p>

        <p class="text-xs text-gray-500 mt-3">
            Du skal klare 'Let' med **100%** og 'Normal' med **90%** for at låse op.<br>
            <strong>Tip:</strong> Feltet er "FCK Fan" som standard – ændr det hvis du vil!
        </p>

        <button id="reset-all-progress" class="text-xs text-red-600 underline mt-2">Nulstil alle fremskridt (Test)</button>
    </div>

    <div id="quiz-container" class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-xl text-center hidden">
        <h1 id="quiz-title" class="text-2xl md:text-3xl font-bold mb-4 text-blue-900">FCK Quiz</h1>
        
        <div id="progress-bar-container" class="hidden">
            <div id="progress-bar"></div>
        </div>
        
        <div id="timer-bar-container" class="hidden">
            <div id="timer-bar"></div>
        </div>

        <div id="timer-display" class="hidden text-3xl font-bold mb-4">15</div>
        
        <div id="question-area" class="mb-6">
            <p id="question-number" class="text-sm text-gray-500 mb-2"></p>
            <p id="question-text" class="text-lg font-semibold mb-4"></p>
            <div id="answer-options" class="grid grid-cols-1 gap-3"></div>
            <div id="text-input-area" class="hidden mt-4">
                <input type="text" id="text-answer-input" placeholder="Indtast dit svar..." class="w-full px-4 py-2 border border-gray-300 rounded-md mb-3" autocomplete="off">
                <button id="submit-text-answer" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Svar</button>
            </div>
            <div id="inline-feedback-area" class="mt-4 hidden border-t pt-4">
                <p id="feedback-question-text" class="text-sm italic text-gray-600 mb-2"></p>
                <p id="feedback-text" class="font-semibold mb-2"></p>
                <p id="rationale-text" class="text-sm text-gray-700"></p>
                <button id="inline-next-button" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition hidden">Næste Spørgsmål</button>
            </div>
        </div>
        <div id="results-area" class="hidden text-center">
            <h2 class="text-xl font-bold mb-4">Resultat for <span id="player-name" class="text-blue-700"></span></h2>
            <p id="score" class="text-lg mb-4"></p>
            <p id="highscore-result-display" class="text-md mb-2 text-gray-600"></p>
            <p id="final-message" class="mb-6"></p>
            <button id="continue-to-next-level-button" class="quiz-button w-full px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold mt-4 hidden">
                Fortsæt til Næste Niveau
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
                <button id="restart-same-quiz-button" class="quiz-button px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Tag Samme Quiz Igen</button>
                <button id="restart-new-quiz-button" class="quiz-button w-full md:w-auto px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">Ny Quiz (Resterende Pulje)</button>
            </div>
            <button id="email-button" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition mt-4 w-full">Send Resultat via E-mail</button>
            <button id="back-to-start-button" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition mt-2 w-full">Tilbage til Start</button>
        </div>
    </div>

    <script>
        // === DATABASER ===
        const spillerDatabase = [
          { "nummer": 1, "navn": "Dominik Kotarski", "position": "Målmand", "nationalitet": "Kroatien", "fødselsdato": "2000-02-10", "type": "Spiller" },
          { "nummer": 31, "navn": "Rúnar Alex Rúnarsson", "position": "Målmand", "nationalitet": "Island", "fødselsdato": "1995-02-18", "type": "Spiller" },
          { "nummer": 61, "navn": "Oscar Gadeberg Buur", "position": "Målmand", "nationalitet": "Danmark", "fødselsdato": "2006-10-29", "type": "Spiller" },
          { "nummer": 4, "navn": "Munashe Garananga", "position": "Forsvar", "nationalitet": "Zimbabwe", "fødselsdato": "2001-01-18", "type": "Spiller" },
          { "nummer": 5, "navn": "Gabriel Pereira", "position": "Forsvar", "nationalitet": "Brasilien", "fødselsdato": "2000-05-07", "type": "Spiller" },
          { "nummer": 6, "navn": "Pantelis Hatzidiakos", "position": "Forsvar", "nationalitet": "Grækenland", "fødselsdato": "1997-01-18", "type": "Spiller" },
          { "nummer": 13, "navn": "Rodrigo Huescas", "position": "Forsvar", "nationalitet": "Mexico", "fødselsdato": "2003-09-18", "type": "Spiller" },
          { "nummer": 15, "navn": "Marcos Lopez", "position": "Forsvar", "nationalitet": "Peru", "fødselsdato": "1999-11-20", "type": "Spiller" },
          { "nummer": 20, "navn": "Junnosuke Suzuki", "position": "Forsvar", "nationalitet": "Japan", "fødselsdato": "2003-07-12", "type": "Spiller" },
          { "nummer": 22, "navn": "Yoram Zague", "position": "Forsvar", "nationalitet": "Frankrig", "fødselsdato": "2006-05-15", "type": "Spiller" },
          { "nummer": 24, "navn": "Birger Meling", "position": "Forsvar", "nationalitet": "Norge", "fødselsdato": "1994-12-17", "type": "Spiller" },
          { "nummer": 8, "navn": "Magnus Mattsson", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "1999-02-25", "type": "Spiller" },
          { "nummer": 12, "navn": "Lukas Lerager", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "1993-07-12", "type": "Spiller" },
          { "nummer": 21, "navn": "Mads Emil Madsen", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "1998-01-14", "type": "Spiller" },
          { "nummer": 23, "navn": "Dominik Sarapata", "position": "Midtbane", "nationalitet": "Polen", "fødselsdato": "2007-10-25", "type": "Spiller" },
          { "nummer": 27, "navn": "Thomas Delaney", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "1991-09-03", "type": "Spiller" },
          { "nummer": 29, "navn": "Jonathan Moalem", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "2007-02-01", "type": "Spiller" },
          { "nummer": 36, "navn": "William Clem", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "2004-06-20", "type": "Spiller" },
          { "nummer": 38, "navn": "Oliver Højer", "position": "Midtbane", "nationalitet": "Danmark", "fødselsdato": "2007-01-24", "type": "Spiller" },
          { "nummer": 7, "navn": "Viktor Claesson", "position": "Angreb", "nationalitet": "Sverige", "fødselsdato": "1992-01-02", "type": "Spiller" },
          { "nummer": 9, "navn": "Youssoufa Moukoko", "position": "Angreb", "nationalitet": "Tyskland", "fødselsdato": "2004-11-20", "type": "Spiller" },
          { "nummer": 10, "navn": "Mohamed Elyounoussi", "position": "Angreb", "nationalitet": "Norge", "fødselsdato": "1994-08-04", "type": "Spiller" },
          { "nummer": 11, "navn": "Jordan Larsson", "position": "Angreb", "nationalitet": "Sverige", "fødselsdato": "1997-06-20", "type": "Spiller" },
          { "nummer": 14, "navn": "Andreas Cornelius", "position": "Angreb", "nationalitet": "Danmark", "fødselsdato": "1993-03-16", "type": "Spiller" },
          { "nummer": 16, "navn": "Robert Silva", "position": "Angreb", "nationalitet": "Brasilien", "fødselsdato": "2005-04-13", "type": "Spiller" },
          { "nummer": 30, "navn": "Elias Achouri", "position": "Angreb", "nationalitet": "Tunesien", "fødselsdato": "1999-02-10", "type": "Spiller" },
          { "nummer": 49, "navn": "Liam West", "position": "Angreb", "nationalitet": "Norge", "fødselsdato": "2007-12-16", "type": "Spiller" }
        ];
        const stabDatabase = [
          { "navn": "Jacob Neestrup", "position": "Cheftræner", "nationalitet": "Danmark", "fødselsdato": "1988-03-08", "type": "Stab" },
          { "navn": "Hjalte Bo Nørregaard", "position": "Assistenttræner", "nationalitet": "Danmark", "fødselsdato": "1981-04-08", "type": "Stab" },
          { "navn": "Stefan Madsen", "position": "Assistenttræner", "nationalitet": "Danmark", "fødselsdato": null, "type": "Stab" },
          { "navn": "Sergio Almenara", "position": "Assistenttræner", "nationalitet": "Spanien", "fødselsdato": "1980-04-07", "type": "Stab" },
          { "navn": "Kim Christensen", "position": "Målmandstræner", "nationalitet": "Danmark", "fødselsdato": "1979-07-16", "type": "Stab" },
          { "navn": "Andrew Clark", "position": "Fysisk træner", "nationalitet": "Australien", "fødselsdato": null, "type": "Stab" }
        ];
        const personDatabase = [...spillerDatabase, ...stabDatabase];

        // === GLOBALE VARIABLER ===
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let playerName = 'FCK Fan'; 
        let quizData = { questions: [] };
        let sessionUsedPersons = []; 
        let currentDifficulty = 'normal';
        let quizInProgress = false;
        let timerInterval = null;
        let timeLeft = 15;
        const TIMER_DURATION = 15;

        // 24-TIMERS LOGIK: Nøgler og varighed
        const HIGH_SCORE_KEY = 'fckQuizHighScores';
        const QUIZ_PROGRESS_KEY = 'fckQuizProgress';
        const TWENTY_FOUR_HOURS_MS = 24 * 60 * 60 * 1000;

        // === DOM ELEMENTER ===
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const nameInput = document.getElementById('name-input');
        const startEasyButton = document.getElementById('start-easy-quiz');
        const startNormalButton = document.getElementById('start-normal-quiz');
        const startHardButton = document.getElementById('start-hard-quiz');
        const startStraffesparkButton = document.getElementById('start-straffespark-quiz'); 
        const quizTitleEl = document.getElementById('quiz-title');
        const questionArea = document.getElementById('question-area');
        const resultsArea = document.getElementById('results-area');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const answerOptionsEl = document.getElementById('answer-options');
        const inlineFeedbackArea = document.getElementById('inline-feedback-area');
        const feedbackTextEl = document.getElementById('feedback-text');
        const rationaleTextEl = document.getElementById('rationale-text');
        const feedbackQuestionTextEl = document.getElementById('feedback-question-text');
        const inlineNextButton = document.getElementById('inline-next-button');
        const scoreEl = document.getElementById('score');
        const finalMessageEl = document.getElementById('final-message');
        const playerNameEl = document.getElementById('player-name');
        const emailButton = document.getElementById('email-button');
        const backToStartButton = document.getElementById('back-to-start-button');
        const restartSameQuizButton = document.getElementById('restart-same-quiz-button');
        const restartNewQuizButton = document.getElementById('restart-new-quiz-button');
        const textInputArea = document.getElementById('text-input-area');
        const textAnswerInput = document.getElementById('text-answer-input');
        const submitTextAnswer = document.getElementById('submit-text-answer');
        const continueToNextLevelButton = document.getElementById('continue-to-next-level-button');
        const timerDisplay = document.getElementById('timer-display');
        
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const timerBarContainer = document.getElementById('timer-bar-container');
        const timerBar = document.getElementById('timer-bar');
        
        const easyHighscoreEl = document.getElementById('easy-highscore-display');
        const normalHighscoreEl = document.getElementById('normal-highscore-display');
        const hardHighscoreEl = document.getElementById('hard-highscore-display');
        const straffesparkHighscoreEl = document.getElementById('straffespark-highscore-display');
        const highscoreResultEl = document.getElementById('highscore-result-display');


        // === INITIALISERING ===
        window.addEventListener('load', () => {
            nameInput.value = playerName;
            checkQuizStatus(); 
        });
        
        // === HJÆLPEFUNKTIONER ===
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array; 
        }
        function getUniqueWrongOptions(sourceArray, correctValue, count) {
            const wrongOptions = new Set();
            const shuffledSource = shuffleArray([...sourceArray]);
            for (const item of shuffledSource) {
                if (item !== correctValue) wrongOptions.add(item);
                if (wrongOptions.size >= count) break;
            }
            return Array.from(wrongOptions);
        }
        function isCorrectName(given, correctFullName) {
            const normalize = s => s.trim().toLowerCase()
                                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                                .replace(/[^a-z0-9æøå]/g, ''); 
            const givenNorm = normalize(given);
            if (givenNorm.length === 0) return false;
            if (!correctFullName) return false; 
            const nameParts = correctFullName.split(' ');
            const firstNorm = normalize(nameParts[0]);
            const lastNorm = normalize(nameParts[nameParts.length - 1]);
            const fullNorm = normalize(correctFullName);
            return givenNorm === fullNorm || givenNorm === firstNorm || givenNorm === lastNorm;
        }
        
        // === HIGH SCORE FUNKTIONER ===
        
        function getHighScores() {
            const scores = localStorage.getItem(HIGH_SCORE_KEY);
            const defaultScores = {
                easy: { score: 0, total: 10, name: '-' },
                normal: { score: 0, total: 10, name: '-' },
                hard: { score: 0, total: 10, name: '-' },
                straffespark: { score: 0, total: 0, name: '-' } 
            };
            try {
                return scores ? { ...defaultScores, ...JSON.parse(scores) } : defaultScores;
            } catch (e) {
                return defaultScores;
            }
        }
        function saveHighScores(scores) {
            localStorage.setItem(HIGH_SCORE_KEY, JSON.stringify(scores));
        }
        function updateHighScoreDisplay() {
            const highScores = getHighScores();
            easyHighscoreEl.textContent = `Rekord: ${highScores.easy.score} / ${highScores.easy.total} (${highScores.easy.name})`;
            normalHighscoreEl.textContent = `Rekord: ${highScores.normal.score} / ${highScores.normal.total} (${highScores.normal.name})`;
            hardHighscoreEl.textContent = `Rekord: ${highScores.hard.score} / ${highScores.hard.total} (${highScores.hard.name})`;
            straffesparkHighscoreEl.textContent = `Straffespark Rekord: ${highScores.straffespark.score} (${highScores.straffespark.name})`;
        }

        // === 24-TIMERS LOGIK OG GAMEFLOW ===
        
        function getQuizProgress() {
            const progress = localStorage.getItem(QUIZ_PROGRESS_KEY);
            try {
                return progress ? JSON.parse(progress) : null;
            } catch (e) {
                return null;
            }
        }
        function saveQuizProgress(progress) {
            localStorage.setItem(QUIZ_PROGRESS_KEY, JSON.stringify(progress));
        }

        function updateUnlockUI(unlocks) {
            const unlocked = unlocks || ['easy']; 

            startEasyButton.querySelector('.text-xs').innerHTML = unlocked.includes('normal') ? "Klaret!" : "Start her for at låse op";
            
            if (unlocked.includes('normal')) {
                startNormalButton.disabled = false;
                startNormalButton.classList.remove('opacity-60', 'cursor-not-allowed');
                startNormalButton.querySelector('.text-xl').innerHTML = "Normal ✔️";
                startNormalButton.querySelector('.text-xs').innerHTML = unlocked.includes('hard') ? "Klaret!" : "Klar 'Normal' med 90%";
            } else {
                startNormalButton.disabled = true;
                startNormalButton.classList.add('opacity-60', 'cursor-not-allowed');
                startNormalButton.querySelector('.text-xl').innerHTML = "Normal [Locked]";
                startNormalButton.querySelector('.text-xs').innerHTML = "Klar 'Let' med 100%";
            }
            
            if (unlocked.includes('hard')) { // 'hard' og 'straffespark' låses op samtidigt
                startHardButton.disabled = false;
                startHardButton.classList.remove('opacity-60', 'cursor-not-allowed');
                startHardButton.querySelector('.text-xl').innerHTML = "Ekspert ✔️";
                startHardButton.querySelector('.text-xs').innerHTML = "Mest Frit Svar (15s. timer)";
                startStraffesparkButton.classList.remove('hidden');
            } else {
                startHardButton.disabled = true;
                startHardButton.classList.add('opacity-60', 'cursor-not-allowed');
                startHardButton.querySelector('.text-xl').innerHTML = "Ekspert [Locked]";
                startHardButton.querySelector('.text-xs').innerHTML = "Klar 'Normal' med 90%";
                startStraffesparkButton.classList.add('hidden');
            }
        }

        function checkQuizStatus() {
            const now = new Date().getTime();
            let progress = getQuizProgress();
            
            if (progress && progress.expiresAt) {
                if (now > progress.expiresAt) { // UDLØBET!
                    localStorage.removeItem(QUIZ_PROGRESS_KEY);
                    localStorage.removeItem(HIGH_SCORE_KEY);
                    if (confirm("Dine 24 timers adgang er udløbet! Alle fremskridt og high scores er nulstillet.\n\nVil du tage en 'Bonus Quiz' (3 spørgsmål) for at låse 'Normal' op igen?")) {
                        startBonusQuiz();
                        return; 
                    } else {
                        progress = null; 
                    }
                }
            }
            
            if (progress && progress.usedPersons) {
                sessionUsedPersons = progress.usedPersons;
            } else {
                sessionUsedPersons = [];
            }
            
            updateUnlockUI(progress ? progress.unlocks : null);
            updateHighScoreDisplay();
        }

        function startBonusQuiz() {
            let name = nameInput.value.trim();
            if (!name) name = "FCK Fan"; 
            playerName = name; 
            
            currentDifficulty = 'bonus';
            sessionUsedPersons = []; 
            generateRandomQuiz('bonus'); 
            quizTitleEl.textContent = "Bonus Quiz (Lås 'Normal' op)";
            startQuizLogic();
        }
        
        function resetAllProgress() {
            if (confirm("Er du sikker? Dette nulstiller ALLE dine high scores og låste levels.")) {
                localStorage.removeItem(HIGH_SCORE_KEY);
                localStorage.removeItem(QUIZ_PROGRESS_KEY);
                location.reload();
            }
        }

        // === QUIZ GENERATOR ===
        
        // ÆNDRING: Tilføjet REL_ER_POSITION
        const questionTypes = { SPILLER_NR_TIL_NAVN: 0, SPILLER_NAVN_TIL_NR: 1, PERSON_NAVN_TIL_POS: 2, PERSON_NAVN_TIL_NAT: 3, PERSON_NAVN_TIL_AAR: 4, STAB_POS_TIL_NAVN: 5, TÆL_NATIONALITET: 6, REL_YNGSTE: 7, REL_IKKE_SKANDINAVIEN: 8, REL_IKKE_POSITION: 9, REL_ER_POSITION: 10 };
        
        const difficultySettings = {
            easy: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT ],
            // ÆNDRING: Tilføjet REL_ER_POSITION
            normal: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT, questionTypes.STAB_POS_TIL_NAVN, questionTypes.REL_YNGSTE, questionTypes.REL_IKKE_POSITION, questionTypes.REL_ER_POSITION ],
            hard: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT, questionTypes.PERSON_NAVN_TIL_AAR, questionTypes.STAB_POS_TIL_NAVN, questionTypes.TÆL_NATIONALITET, questionTypes.REL_YNGSTE, questionTypes.REL_IKKE_SKANDINAVIEN, questionTypes.REL_IKKE_POSITION, questionTypes.REL_ER_POSITION ],
            bonus: [ questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.PERSON_NAVN_TIL_POS, questionTypes.PERSON_NAVN_TIL_NAT ]
        };

        function getMultipleUniquePersons(count, pool) {
            let available = pool.filter(p => !sessionUsedPersons.some(used => used.navn === p.navn));
            if (available.length < count) {
                if (currentDifficulty !== 'bonus') {
                    console.log("Person-puljen er ved at være tom til relationelt spørgsmål. Nulstiller puljen.");
                    sessionUsedPersons = []; 
                }
                available = [...pool];
            }
            return shuffleArray(available).slice(0, count);
        }

        function generateRandomQuiz(difficulty) {
            const setting = (difficulty === 'straffespark') ? 'hard' : difficulty;
            const allowedTypes = difficultySettings[setting];

            if (difficulty === 'straffespark') {
                quizTitleEl.textContent = '⚡ Straffespark ⚡';
            } else if (difficulty !== 'bonus') { 
                quizTitleEl.textContent = `FCK Quiz (${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)})`;
            }
            
            let availablePlayers = spillerDatabase.filter(p => !sessionUsedPersons.some(used => used.navn === p.navn));
            let availableStab = stabDatabase.filter(s => !sessionUsedPersons.some(used => used.navn === s.navn));
            
            let totalAvailable = (difficulty === 'easy') ? availablePlayers.length : availablePlayers.length + availableStab.length;

            if (totalAvailable < 4 && difficulty !== 'bonus') {
                console.log("Person-puljen er ved at være tom. Nulstiller puljen og fortsætter quizzen.");
                sessionUsedPersons = []; 
                
                availablePlayers = [...spillerDatabase];
                availableStab = [...stabDatabase];
                totalAvailable = (difficulty === 'easy') ? availablePlayers.length : availablePlayers.length + availableStab.length;
            }

            const numQuestions = (difficulty === 'straffespark') ? 50 : (difficulty === 'bonus') ? 3 : Math.min(10, totalAvailable);
            
            const newQuestions = [];
            let quizPersons = [];

            while (newQuestions.length < numQuestions) {
                if (totalAvailable === 0 || (difficulty === 'easy' && availablePlayers.length === 0) || 
                    (difficulty !== 'easy' && difficulty !== 'bonus' && availablePlayers.length === 0 && availableStab.length === 0)) break;

                let questionData = null;
                let questionType = allowedTypes[Math.floor(Math.random() * allowedTypes.length)];
                
                const isTextInput = (difficulty === 'hard' || difficulty === 'straffespark') && 
                                     [questionTypes.SPILLER_NR_TIL_NAVN, questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.PERSON_NAVN_TIL_AAR, questionTypes.TÆL_NATIONALITET].includes(questionType);

                if ([questionTypes.SPILLER_NAVN_TIL_NR, questionTypes.SPILLER_NR_TIL_NAVN].includes(questionType) && availablePlayers.length === 0) { 
                    questionType = questionTypes.PERSON_NAVN_TIL_POS; 
                }
                if (difficulty !== 'easy' && questionType === questionTypes.STAB_POS_TIL_NAVN && availableStab.length === 0) { 
                    questionType = questionTypes.PERSON_NAVN_TIL_POS; 
                }
                // ÆNDRING: Tjekker nu også for REL_ER_POSITION
                if ([questionTypes.REL_YNGSTE, questionTypes.REL_IKKE_SKANDINAVIEN, questionTypes.REL_IKKE_POSITION, questionTypes.REL_ER_POSITION].includes(questionType) && availablePlayers.length < 4) {
                    continue; 
                }


                let correctPerson = null;
                
                switch(questionType) {
                    case questionTypes.SPILLER_NR_TIL_NAVN: {
                        let pool = (difficulty === 'bonus') ? [...spillerDatabase] : availablePlayers; 
                        correctPerson = shuffleArray(pool).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        questionData = { question: `Hvem bærer rygnummer ${correctPerson.nummer}?`, correct: correctPerson.navn, rationale: `${correctPerson.navn} bærer korrekt nummer ${correctPerson.nummer}.` };
                        if (!isTextInput) {
                            const wrongPlayers = personDatabase.filter(p => p.navn !== correctPerson.navn && p.type === 'Spiller');
                            questionData.wrong = getUniqueWrongOptions(wrongPlayers.map(p => p.navn), correctPerson.navn, 3).map(navn => ({ text: navn, rationale: `${navn} bærer nummer ${personDatabase.find(p => p.navn === navn).nummer}.` }));
                        }
                        break;
                    }
                    case questionTypes.SPILLER_NAVN_TIL_NR: {
                        let pool = (difficulty === 'bonus') ? [...spillerDatabase] : availablePlayers;
                        correctPerson = shuffleArray(pool).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        questionData = { question: `Hvilket rygnummer har ${correctPerson.navn}?`, correct: correctPerson.nummer.toString(), rationale: `${correctPerson.navn} bærer korrekt nummer ${correctPerson.nummer}.` };
                        if (!isTextInput) {
                            const wrongPlayers = personDatabase.filter(p => p.navn !== correctPerson.navn && p.type === 'Spiller');
                            questionData.wrong = getUniqueWrongOptions(wrongPlayers.map(p => p.nummer.toString()), correctPerson.nummer.toString(), 3).map(num => ({ text: num, rationale: `Nummer ${num} tilhører ${personDatabase.find(p => p.nummer.toString() === num).navn}.` }));
                        }
                        break;
                    }
                    case questionTypes.PERSON_NAVN_TIL_POS: {
                        let pool = (difficulty === 'easy' || difficulty === 'bonus') ? availablePlayers : [...availablePlayers, ...availableStab];
                        if (difficulty === 'bonus') pool = [...spillerDatabase];
                        correctPerson = shuffleArray(pool).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue; 
                        const allPositions = [...new Set(personDatabase.map(p => p.position))];
                        const wrongOptions = getUniqueWrongOptions(allPositions, correctPerson.position, 3);
                        questionData = { question: `Hvilken position/stilling har ${correctPerson.navn}?`, correct: correctPerson.position, rationale: `${correctPerson.navn} er korrekt ${correctPerson.position}.`, wrong: wrongOptions.map(pos => ({ text: pos, rationale: `${correctPerson.navn} er ${correctPerson.position}, ikke ${pos}.` })) };
                        break;
                    }
                    case questionTypes.PERSON_NAVN_TIL_NAT: {
                        let pool = (difficulty === 'easy' || difficulty === 'bonus') ? availablePlayers : [...availablePlayers, ...availableStab];
                        if (difficulty === 'bonus') pool = [...spillerDatabase];
                        correctPerson = shuffleArray(pool).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        const allNats = [...new Set(personDatabase.map(p => p.nationalitet))];
                        const wrongOptions = getUniqueWrongOptions(allNats, correctPerson.nationalitet, 3);
                        questionData = { 
                            question: `Hvor kommer ${correctPerson.navn} fra?`, 
                            correct: correctPerson.nationalitet, 
                            rationale: `${correctPerson.navn} er korrekt fra ${correctPerson.nationalitet}.`, 
                            wrong: wrongOptions.map(nat => ({ text: nat, rationale: `${correctPerson.navn} er fra ${correctPerson.nationalitet}.` })) 
                        };
                        break;
                    }
                    case questionTypes.PERSON_NAVN_TIL_AAR: {
                        let pool = [...availablePlayers, ...availableStab].filter(p => p.fødselsdato);
                        correctPerson = shuffleArray(pool).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        const year = correctPerson.fødselsdato.substring(0, 4);
                        questionData = { question: `Hvilket år er ${correctPerson.navn} født?`, correct: year, rationale: `${correctPerson.navn} er korrekt født i ${year}.` };
                        if (!isTextInput) {
                            const allYears = [...new Set(personDatabase.filter(p => p.fødselsdato).map(p => p.fødselsdato.substring(0, 4)))];
                            questionData.wrong = getUniqueWrongOptions(allYears, year, 3).map(y => ({ text: y, rationale: `${correctPerson.navn} er født i ${year}.` }));
                        }
                        break;
                    }
                    case questionTypes.STAB_POS_TIL_NAVN: {
                        correctPerson = shuffleArray(availableStab).find(p => !quizPersons.includes(p.navn));
                        if (!correctPerson) continue;
                        const position = correctPerson.position;
                        const peopleWithThisPosition = stabDatabase.filter(s => s.position === position).length;
                        const isUniquePosition = (peopleWithThisPosition === 1);
                        let questionText = isUniquePosition ? `Hvem har stillingen: ${position}?` : `Hvilken af følgende personer er ${position}?`;
                        const wrongPeople = personDatabase.filter(p => p.position !== position && p.navn !== correctPerson.navn);
                        const wrongOptions = getUniqueWrongOptions(wrongPeople.map(p => p.navn), correctPerson.navn, 3);
                        questionData = {
                            question: questionText,
                            correct: correctPerson.navn,
                            rationale: `${correctPerson.navn} er korrekt ${position}.`,
                            wrong: wrongOptions.map(navn => ({ text: navn, rationale: `${navn} er ${personDatabase.find(s=>s.navn === navn).position}.` }))
                        };
                        break;
                    }
                    case questionTypes.TÆL_NATIONALITET: {
                        const natCounts = {};
                        spillerDatabase.forEach(p => { natCounts[p.nationalitet] = (natCounts[p.nationalitet] || 0) + 1; });
                        const popularNats = Object.keys(natCounts).filter(nat => natCounts[nat] > 1);
                        if (popularNats.length === 0) continue;
                        const natToCount = shuffleArray(popularNats)[0];
                        const correctCount = natCounts[natToCount];
                        questionData = { question: `Hvor mange spillere fra ${natToCount} er der i A-truppen?`, correct: correctCount.toString(), rationale: `Der er korrekt ${correctCount} spillere fra ${natToCount} (f.eks. ${spillerDatabase.filter(p=>p.nationalitet === natToCount).map(p=>p.navn).join(', ')}).`};
                        if (!isTextInput) {
                            let wrongCounts = new Set([correctCount + 1, Math.max(1, correctCount - 1), correctCount + 2]);
                            while(wrongCounts.size < 3 || wrongCounts.has(correctCount)) { wrongCounts.add(Math.max(1, correctCount + Math.floor(Math.random() * 3) - 1)); wrongCounts.delete(correctCount); }
                            questionData.wrong = Array.from(wrongCounts).slice(0,3).map(c => ({ text: c.toString(), rationale: `Det korrekte antal er ${correctCount}.` }));
                        }
                        break;
                    }
                    case questionTypes.REL_YNGSTE: {
                        const pool = [...availablePlayers].filter(p => p.fødselsdato);
                        if (pool.length < 4) continue;
                        const people = getMultipleUniquePersons(4, pool);
                        people.sort((a, b) => new Date(b.fødselsdato) - new Date(a.fødselsdato)); // Nyeste dato = yngst
                        correctPerson = people[0];
                        questionData = {
                            question: "Hvem af disse spillere er YNGST?",
                            correct: correctPerson.navn,
                            rationale: `${correctPerson.navn} (født ${correctPerson.fødselsdato}) er den yngste af de fire.`,
                            wrong: [people[1], people[2], people[3]].map(p => ({ text: p.navn, rationale: `${p.navn} er født ${p.fødselsdato}.` }))
                        };
                        break;
                    }
                    case questionTypes.REL_IKKE_POSITION: {
                        const positions = ["Forsvar", "Midtbane", "Angreb"];
                        const pos = positions[Math.floor(Math.random() * positions.length)];
                        const poolCorrect = availablePlayers.filter(p => p.position === pos);
                        const poolWrong = availablePlayers.filter(p => p.position !== pos && p.position !== "Målmand");
                        if (poolCorrect.length < 3 || poolWrong.length < 1) continue; 

                        const correctPeople = getMultipleUniquePersons(3, poolCorrect);
                        correctPerson = getMultipleUniquePersons(1, poolWrong)[0];
                        
                        questionData = {
                            question: `Hvem af disse er IKKE ${pos}spiller?`,
                            correct: correctPerson.navn,
                            rationale: `${correctPerson.navn} er ${correctPerson.position}.`,
                            wrong: correctPeople.map(p => ({ text: p.navn, rationale: `${p.navn} er ${p.position}.` }))
                        };
                        break;
                    }
                    case questionTypes.REL_IKKE_SKANDINAVIEN: {
                        const skandinaver = ["Danmark", "Norge", "Sverige"];
                        const poolSkandi = availablePlayers.filter(p => skandinaver.includes(p.nationalitet));
                        const poolIkkeSkandi = availablePlayers.filter(p => !skandinaver.includes(p.nationalitet));
                        if (poolSkandi.length < 3 || poolIkkeSkandi.length < 1) continue;

                        const correctPeople = getMultipleUniquePersons(3, poolSkandi);
                        correctPerson = getMultipleUniquePersons(1, poolIkkeSkandi)[0];
                        
                        questionData = {
                            question: "Hvem af disse er IKKE fra Skandinavien?",
                            correct: correctPerson.navn,
                            rationale: `${correctPerson.navn} er fra ${correctPerson.nationalitet}.`,
                            wrong: correctPeople.map(p => ({ text: p.navn, rationale: `${p.navn} er fra ${p.nationalitet}.` }))
                        };
                        break;
                    }
                    // ÆNDRING: NY SPØRGSMÅLSTYPE
                    case questionTypes.REL_ER_POSITION: {
                        const positions = ["Forsvar", "Midtbane", "Angreb"];
                        const pos = positions[Math.floor(Math.random() * positions.length)];
                        const poolCorrect = availablePlayers.filter(p => p.position === pos);
                        const poolWrong = availablePlayers.filter(p => p.position !== pos);
                        
                        if (poolCorrect.length < 1 || poolWrong.length < 3) continue; 

                        correctPerson = getMultipleUniquePersons(1, poolCorrect)[0];
                        const wrongPeople = getMultipleUniquePersons(3, poolWrong);
                        
                        questionData = {
                            question: `Hvem af disse ER ${pos}spiller?`,
                            correct: correctPerson.navn,
                            rationale: `${correctPerson.navn} er korrekt ${correctPerson.position}.`,
                            wrong: wrongPeople.map(p => ({ text: p.navn, rationale: `${p.navn} er ${p.position}, ikke ${pos}spiller.` }))
                        };
                        break;
                    }
                }
                
                if (questionData && (correctPerson || questionData.correct)) {
                    if (isTextInput) {
                        newQuestions.push({
                            questionNumber: newQuestions.length + 1,
                            question: questionData.question,
                            isTextInput: true,
                            correctAnswer: questionData.correct,
                            rationale: questionData.rationale,
                            questionType: questionType,
                            fullName: (questionType === questionTypes.SPILLER_NR_TIL_NAVN) ? correctPerson.navn : null 
                        });
                    } else {
                        const answerOptions = [{ text: questionData.correct, rationale: questionData.rationale, isCorrect: true }];
                        questionData.wrong.forEach(opt => answerOptions.push({ text: opt.text, rationale: opt.rationale, isCorrect: false }));
                        shuffleArray(answerOptions);
                        newQuestions.push({
                            questionNumber: newQuestions.length + 1,
                            question: questionData.question,
                            answerOptions: answerOptions,
                            isTextInput: false
                        });
                    }
                    if (correctPerson && difficulty !== 'bonus') { 
                        quizPersons.push(correctPerson.navn);
                        sessionUsedPersons.push(correctPerson);
                        availablePlayers = availablePlayers.filter(p => p.navn !== correctPerson.navn);
                        availableStab = availableStab.filter(s => s.navn !== correctPerson.navn);
                    }
                }
            } // Slut på while-løkke
            quizData = { questions: newQuestions };

            if (difficulty !== 'bonus') {
                let progress = getQuizProgress(); 
                if (progress) {
                    progress.usedPersons = sessionUsedPersons; 
                    saveQuizProgress(progress);
                }
            }
            
            startQuizLogic();
        }


        // === KERNELOGIK FOR QUIZ ===
        function startQuizLogic() {
            if (!playerName) return;
            startScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            questionArea.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            questions = [...quizData.questions];
            if (questions.length === 0) {
                console.error("Fejl: Forsøgte at starte en quiz med 0 spørgsmål.");
                goBackToStart();
                return;
            }
            loadQuestion();
        }
        
        function startQuizFromMenu(difficulty) {
            let name = nameInput.value.trim();
            if (!name) {
                name = "FCK Fan"; 
            }
            playerName = name; 
            
            currentDifficulty = difficulty;
            
            let progress = getQuizProgress();
            const now = new Date().getTime();
            if (!progress) {
                alert("Quizzen er startet! Du har nu 24 timer til at klare alle levels, før din fremgang nulstilles.");
                progress = {
                    unlocks: ['easy'],
                    expiresAt: now + TWENTY_FOUR_HOURS_MS,
                    usedPersons: []
                };
                saveQuizProgress(progress);
                sessionUsedPersons = [];
            }
            
            generateRandomQuiz(difficulty);
        }

        function goBackToStart() {
             stopTimer();
             quizContainer.classList.add('hidden');
             startScreen.classList.remove('hidden');
             nameInput.value = playerName; 
             checkQuizStatus();
        }
        
        function restartSameQuiz() {
            startQuizLogic(); 
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerDisplay.classList.add('hidden');
            timerBarContainer.classList.add('hidden');
            timerBar.style.transition = 'none'; 
        }

        function handleTimeUp() {
            stopTimer();
            quizInProgress = true;
            textAnswerInput.disabled = true;
            submitTextAnswer.disabled = true;
            answerOptionsEl.querySelectorAll('button').forEach(b => b.disabled = true);
            
            if (currentDifficulty === 'straffespark') {
                feedbackTextEl.textContent = 'Tiden løb ud! Spillet er slut.';
                feedbackTextEl.style.color = '#dc3545';
                setTimeout(showResults, 1500);
                return;
            }
            
            feedbackTextEl.textContent = 'Tiden løb ud!';
            feedbackTextEl.style.color = '#dc3545';
            const currentQuestion = questions[currentQuestionIndex];
            let rationale = "";
            if (currentQuestion.isTextInput) {
                rationale = `Det korrekte svar er <strong>${currentQuestion.correctAnswer}</strong>. ${currentQuestion.rationale}`;
            } else {
                const correctOpt = currentQuestion.answerOptions.find(opt => opt.isCorrect);
                rationale = correctOpt.rationale;
                answerOptionsEl.querySelectorAll('button').forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.classList.add('correct');
                    }
                });
            }
            rationaleTextEl.innerHTML = rationale;
            feedbackQuestionTextEl.innerHTML = currentQuestion.question;
            inlineFeedbackArea.classList.remove('hidden');
            inlineNextButton.classList.remove('hidden'); 
        }
        
        function startTimer() {
            timeLeft = TIMER_DURATION;
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('hidden');
            timerDisplay.classList.remove('text-red-600'); 
            clearInterval(timerInterval);
            
            timerBarContainer.classList.remove('hidden');
            timerBar.style.transition = 'none'; 
            timerBar.style.width = '100%';
            
            setTimeout(() => {
                timerBar.style.transition = `width ${TIMER_DURATION}s linear`;
                timerBar.style.width = '0%';
            }, 50);

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 5) {
                    timerDisplay.classList.add('text-red-600'); 
                }
                if (timeLeft <= 0) {
                    handleTimeUp();
                }
            }, 1000);
        }

        function loadNextOrShowResults() {
            stopTimer(); 
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion();
            } else {
                showResults();
            }
        }

        function loadQuestion() {
            quizInProgress = false;
            inlineFeedbackArea.classList.add('hidden');
            inlineNextButton.classList.add('hidden'); 
            questionArea.classList.remove('hidden'); 
            resultsArea.classList.add('hidden');
            stopTimer(); 
            if (!questions[currentQuestionIndex]) {
                console.error("Fejl: Kunne ikke indlæse spørgsmål. Går til resultater.");
                showResults();
                return;
            }
            const currentQuestion = questions[currentQuestionIndex];
            
            if (currentDifficulty === 'straffespark') {
                 questionNumberEl.textContent = `Straffespark ${currentQuestionIndex + 1} (Rekord: ${getHighScores().straffespark.score})`;
            } else {
                 questionNumberEl.textContent = `Spørgsmål ${currentQuestionIndex + 1} af ${questions.length}`;
            }
            
            if(currentDifficulty !== 'straffespark' && currentDifficulty !== 'bonus') {
                const progressPercent = ((currentQuestionIndex) / questions.length) * 100;
                progressBar.style.width = progressPercent + '%';
                progressBarContainer.classList.remove('hidden');
            } else {
                progressBarContainer.classList.add('hidden'); 
            }

            questionTextEl.innerHTML = currentQuestion.question; 
            if (currentQuestion.isTextInput) {
                answerOptionsEl.innerHTML = '';
                answerOptionsEl.classList.add('hidden');
                textInputArea.classList.remove('hidden');
                textAnswerInput.value = '';
                textAnswerInput.disabled = false;
                submitTextAnswer.disabled = false;
                textAnswerInput.focus();
            } else {
                textInputArea.classList.add('hidden');
                answerOptionsEl.classList.remove('hidden');
                answerOptionsEl.innerHTML = '';
                const options = [...currentQuestion.answerOptions];
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.innerHTML = option.text; 
                    button.classList.add('w-full', 'px-4', 'py-3', 'bg-gray-200', 'rounded-md', 'hover:bg-gray-300', 'transition', 'duration-200', 'text-left');
                    button.dataset.correct = option.isCorrect;
                    button.dataset.rationale = option.rationale;
                    button.onclick = handleAnswer;
                    answerOptionsEl.appendChild(button);
                });
            }
            if (currentDifficulty === 'hard' || currentDifficulty === 'straffespark') {
                startTimer();
            }
        }

        function handleAnswer(event) {
            if (quizInProgress) return;
            quizInProgress = true;
            stopTimer(); 
            const selectedButton = event.target.closest('button');
            const isCorrect = selectedButton.dataset.correct === 'true';
            const rationale = selectedButton.dataset.rationale;
            const buttons = answerOptionsEl.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = true;
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else if (button === selectedButton) {
                    button.classList.add('incorrect');
                }
            });
            if (isCorrect) {
                score++;
                feedbackTextEl.innerHTML = 'Korrekt! ✔️';
                feedbackTextEl.style.color = '#28a745';
                const delay = (currentDifficulty === 'straffespark') ? 1500 : 3000;
                setTimeout(loadNextOrShowResults, delay);
            } else {
                if (currentDifficulty === 'straffespark') {
                    feedbackTextEl.textContent = 'Forkert! Spillet er slut.';
                    feedbackTextEl.style.color = '#dc3545';
                    setTimeout(showResults, 2000);
                } else {
                    feedbackTextEl.textContent = 'Forkert!';
                    feedbackTextEl.style.color = '#dc3545';
                    inlineNextButton.classList.remove('hidden');
                }
            }
            feedbackQuestionTextEl.innerHTML = questions[currentQuestionIndex].question;
            rationaleTextEl.innerHTML = rationale; 
            inlineFeedbackArea.classList.remove('hidden');
        }

        function handleTextInputAnswer() {
            if (quizInProgress) return;
            quizInProgress = true;
            stopTimer(); 
            textAnswerInput.disabled = true;
            submitTextAnswer.disabled = true;
            
            const currentQuestion = questions[currentQuestionIndex];
            const givenAnswer = textAnswerInput.value;
            let isCorrect = false;

            if (currentQuestion.questionType === questionTypes.SPILLER_NR_TIL_NAVN) {
                isCorrect = isCorrectName(givenAnswer, currentQuestion.fullName); 
            } else {
                isCorrect = (givenAnswer.trim().toLowerCase() === currentQuestion.correctAnswer.toLowerCase());
            }

            let rationale;
            if (isCorrect) {
                score++;
                feedbackTextEl.innerHTML = 'Korrekt! ✔️';
                feedbackTextEl.style.color = '#28a745';
                rationale = currentQuestion.rationale;
                const delay = (currentDifficulty === 'straffespark') ? 1500 : 3000;
                setTimeout(loadNextOrShowResults, delay);
            } else {
                rationale = `Det korrekte svar er <strong>${currentQuestion.correctAnswer}</strong>. ${currentQuestion.rationale}`;
                if (currentDifficulty === 'straffespark') {
                    feedbackTextEl.textContent = 'Forkert! Spillet er slut.';
                    feedbackTextEl.style.color = '#dc3545';
                    setTimeout(showResults, 2500); 
                } else {
                    feedbackTextEl.textContent = 'Forkert!';
                    feedbackTextEl.style.color = '#dc3545';
                    inlineNextButton.classList.remove('hidden');
                }
            }
            feedbackQuestionTextEl.innerHTML = currentQuestion.question;
            rationaleTextEl.innerHTML = rationale; 
            inlineFeedbackArea.classList.remove('hidden');
        }

        /**
         * ÆNDRING: Oplåsningskrav er 100% (Let), 90% (Normal), 80% (Ekspert).
         */
        function showResults() {
            quizInProgress = false; 
            stopTimer();
            questionArea.classList.add('hidden'); 
            resultsArea.classList.remove('hidden');
            playerNameEl.textContent = playerName;
            
            progressBarContainer.classList.add('hidden');
            
            if (currentDifficulty === 'bonus') {
                const bonusPercentage = (questions.length > 0 ? (score / questions.length) * 100 : 0);
                if (bonusPercentage >= 66) { // 2 ud af 3
                    alert("Tillykke! Du bestod. 'Normal' er nu låst op for din nye 24-timers session.");
                    const now = new Date().getTime();
                    const newProgress = {
                        unlocks: ['easy', 'normal'], 
                        expiresAt: now + TWENTY_FOUR_HOURS_MS,
                        usedPersons: [] 
                    };
                    saveQuizProgress(newProgress);
                } else {
                    alert("Desværre, du bestod ikke. Du må starte fra 'Let' for at låse op.");
                }
                goBackToStart(); 
                return; 
            }

            continueToNextLevelButton.classList.add('hidden');
            highscoreResultEl.textContent = ''; 
            highscoreResultEl.classList.remove('text-green-600', 'font-semibold');
            
            const numQuestions = (currentDifficulty === 'straffespark') ? score : questions.length;
            let message = '';
            let unlockMessage = '';
            let highScoreMessage = '';

            if (currentDifficulty === 'straffespark') {
                scoreEl.textContent = `Du fik ${score} rigtige i træk!`;
                restartSameQuizButton.classList.add('hidden'); 
                restartNewQuizButton.textContent = 'Prøv Straffespark Igen';
                restartNewQuizButton.onclick = () => startQuizFromMenu('straffespark');
                
                const highScores = getHighScores();
                const oldHighScore = highScores.straffespark.score;
                if (score > oldHighScore) {
                    highScores.straffespark = { score: score, total: 0, name: playerName };
                    saveHighScores(highScores);
                    highScoreMessage = " <strong>Ny Straffespark Rekord!</strong>";
                    highscoreResultEl.textContent = `Ny rekord: ${score} i træk`;
                    highscoreResultEl.classList.add('text-green-600', 'font-semibold');
                    if (score > 0) confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                } else {
                    highscoreResultEl.textContent = `Rekord: ${oldHighScore} i træk (${highScores.straffespark.name})`;
                }
                message = score > 15 ? "Imponerende!" : (score > 5 ? "Godt gået!" : (score > 0 ? "Okay forsøg!" : "Bedre held næste gang..."));
                
            } else { 
                restartNewQuizButton.textContent = 'Ny Quiz (Resterende Pulje)';
                restartNewQuizButton.onclick = () => generateRandomQuiz(currentDifficulty);
                
                if (numQuestions === 0) {
                    scoreEl.textContent = "Der opstod en fejl (0 spørgsmål).";
                    restartSameQuizButton.classList.add('hidden');
                } else {
                    scoreEl.textContent = `Du fik ${score} ud af ${numQuestions} rigtige!`;
                    if (score === numQuestions) {
                        restartSameQuizButton.classList.add('hidden');
                    } else {
                        restartSameQuizButton.classList.remove('hidden');
                    }

                    const highScores = getHighScores();
                    const oldHighScore = highScores[currentDifficulty].score;
                    
                    if (score > oldHighScore) {
                        highScores[currentDifficulty] = { score: score, total: numQuestions, name: playerName };
                        saveHighScores(highScores);
                        highScoreMessage = " <strong>Ny Rekord!</strong>";
                        highscoreResultEl.textContent = `Ny rekord: ${score} / ${numQuestions}`;
                        highscoreResultEl.classList.add('text-green-600', 'font-semibold');
                    } else if (score === oldHighScore && oldHighScore > 0) {
                        highscoreResultEl.textContent = `Rekord: ${highScores[currentDifficulty].score} / ${numQuestions} (Tangering!)`;
                    } else {
                        highscoreResultEl.textContent = `Rekord: ${highScores[currentDifficulty].score} / ${numQuestions} (${highScores[currentDifficulty].name})`;
                    }
                }
                
                const percentage = numQuestions > 0 ? (score / numQuestions) * 100 : 0;
                
                 if (percentage === 100) {
                     message = 'Perfekt score!';
                     confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); 
                 } else if (percentage >= 90) {
                    message = `Suverænt! (${percentage.toFixed(0)}%)`;
                 } else if (percentage >= 80) {
                    message = `Flot klaret! (${percentage.toFixed(0)}%)`;
                 } else if (percentage >= 40) {
                     message = 'Godt forsøgt! Lidt mere træning, så sidder den der.';
                 } else {
                     message = 'Øv! Det kræver vist lidt mere øvelse.';
                 }
                
                // --- ÆNDRING: OPLÅSNINGSLOGIK OPDATERET ---
                
                let progress = getQuizProgress();
                if (!progress) {
                    console.error("Progress-objekt mangler!");
                    progress = { unlocks: ['easy'], usedPersons: sessionUsedPersons };
                }
                let newUnlock = null;
                
                if (currentDifficulty === 'easy') {
                    if (percentage === 100) { // <-- KRAV: 100%
                        if (!progress.unlocks.includes('normal')) { 
                            newUnlock = 'normal';
                            unlockMessage = " <strong>Stærkt! 100%! 'Normal' er nu låst op.</strong>";
                        }
                        startNormalButton.disabled = false;
                        startNormalButton.classList.remove('opacity-60', 'cursor-not-allowed');
                        startNormalButton.querySelector('.text-xl').innerHTML = "Normal ✔️";
                        startEasyButton.querySelector('.text-xs').innerHTML = "Klaret!";
                        
                        continueToNextLevelButton.innerHTML = "Start 'Normal' Nu";
                        continueToNextLevelButton.dataset.nextLevel = "normal";
                        continueToNextLevelButton.classList.remove('hidden');
                    } else if (percentage >= 80) { 
                        unlockMessage = " <strong>Godt klaret! Du skal have 100% for at låse op.</strong>";
                    }

                } else if (currentDifficulty === 'normal') {
                    if (percentage >= 90) { // <-- KRAV: 90%
                        if (!progress.unlocks.includes('hard')) {
                            newUnlock = 'hard'; // 'hard' og 'straffespark' låses op sammen
                            unlockMessage = ` <strong>Suverænt! ${percentage.toFixed(0)}%! 'Ekspert' og 'Straffespark' er låst op.</strong>`;
                        }
                        startHardButton.disabled = false;
                        startHardButton.classList.remove('opacity-60', 'cursor-not-allowed');
                        startHardButton.querySelector('.text-xl').innerHTML = "Ekspert ✔️";
                        startNormalButton.querySelector('.text-xs').innerHTML = "Klaret!";
                        startStraffesparkButton.classList.remove('hidden'); 
                        
                        continueToNextLevelButton.innerHTML = "Prøv 'Ekspert' Nu (15s. timer)";
                        continueToNextLevelButton.dataset.nextLevel = "hard";
                        continueToNextLevelButton.classList.remove('hidden');
                    } else if (percentage >= 80) { 
                        unlockMessage = " <strong>Stærkt! Du skal have 90% for at låse op.</strong>";
                    }

                } else if (currentDifficulty === 'hard') {
                    if (percentage >= 80) { // <-- KRAV: 80% for at bestå 'Ekspert'
                        unlockMessage = " <strong>Imponerende! Du er en ægte FCK-kender.</strong>";
                        // ÆNDRING: Knappen til Straffespark vises
                        continueToNextLevelButton.innerHTML = "Prøv 'Straffespark' Nu ⚡";
                        continueToNextLevelButton.dataset.nextLevel = "straffespark";
                        continueToNextLevelButton.classList.remove('hidden');
                    }
                }
                
                if (newUnlock) {
                    progress.unlocks.push(newUnlock);
                    if (newUnlock === 'hard') {
                        progress.unlocks.push('straffespark'); // Lås begge op
                    }
                    saveQuizProgress(progress);
                }
                // --- SLUT PÅ ÆNDRING ---
            } 
            
            finalMessageEl.innerHTML = message + unlockMessage + highScoreMessage;
            emailButton.onclick = sendEmail;
        }

        function sendEmail() {
            const recipient = "tonnysenior@gmail.com";
            const subject = `FCK Quiz Resultat for ${playerName}`;
            let scoreText = (currentDifficulty === 'straffespark') ? `Score: ${score} rigtige i træk` : `Score: ${score} ud af ${questions.length}`;
            
            const body = `Hej,\n\Her er resultatet for ${playerName} i quizzen "${quizTitleEl.textContent}":\n\n${scoreText}\n\n${finalMessageEl.textContent}\n\nMvh\nQuizzen`;
            const encodedSubject = encodeURIComponent(subject);
            const encodedBody = encodeURIComponent(body);
            const mailtoLink = `mailto:${recipient}?subject=${encodedSubject}&body=${encodedBody}`;
            window.location.href = mailtoLink;
        }

        // === EVENT LISTENERS ===
        startEasyButton.addEventListener('click', () => startQuizFromMenu('easy'));
        startNormalButton.addEventListener('click', () => startQuizFromMenu('normal'));
        startHardButton.addEventListener('click', () => startQuizFromMenu('hard'));
        startStraffesparkButton.addEventListener('click', () => startQuizFromMenu('straffespark')); 
        
        inlineNextButton.addEventListener('click', loadNextOrShowResults);
        backToStartButton.addEventListener('click', goBackToStart);
        restartSameQuizButton.addEventListener('click', restartSameQuiz);
        
        // .onclick sættes i showResults()
        
        continueToNextLevelButton.addEventListener('click', () => {
            const nextDifficulty = continueToNextLevelButton.dataset.nextLevel;
            if (nextDifficulty) {
                startQuizFromMenu(nextDifficulty);
            }
        });
        
        submitTextAnswer.addEventListener('click', handleTextInputAnswer);
        textAnswerInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleTextInputAnswer();
            }
        });
        
        document.getElementById('reset-all-progress').addEventListener('click', resetAllProgress);
        
    </script>

</body>
</html>
